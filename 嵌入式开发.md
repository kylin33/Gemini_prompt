# Embedded Agent Development Guidelines (TDD-Oriented)

## 1. 目标与适用范围（Scope & Mission）
本项目为 **嵌入式系统 / 软硬件协同项目**，涉及 MCU / SoC / FPGA / 传感器 / 驱动 / RTOS / 通信协议等内容。

所有 AI / Agent 参与的开发 **必须遵循 TDD 思想**，并且在编写任何代码之前：
- **优先理解现有硬件设计、软件架构与接口约定**
- **避免重复实现已有驱动、算法或协议栈**
- **尊重资源受限、时序敏感、硬件不可回退的现实约束**

---

## 2. 编码前强制检查（Pre-Code Mandatory Review）

在开始任何代码实现前，Agent **必须完成以下检查**：

### 2.1 文档审查（必须）
优先阅读（如存在）：
- `README.md`
- `docs/`
  - 硬件原理图 / 引脚定义
  - 传感器 Datasheet 摘要
  - 通信协议说明（I2C / SPI / UART / BLE / CAN 等）
- `ARCHITECTURE.md` / `api.md`
- RTOS 使用说明（任务模型、优先级、栈大小约定）

⚠️ **禁止在不了解硬件连接关系、接口定义的情况下编写驱动或底层代码。**

---

### 2.2 现有实现扫描（必须）
Agent 必须确认：
- 是否已有：
  - 传感器驱动 / BSP / HAL 封装
  - 外设初始化代码（Clock / GPIO / DMA / Interrupt）
  - 数据处理或滤波算法
- 是否已有测试或仿真代码覆盖该功能

优先 **扩展或复用**，而不是新建。

---

## 3. 嵌入式场景下的 TDD 工作流

### Step 1：行为定义（先于代码）
在嵌入式场景中，“测试”可以是以下任意形式之一：

- 纯软件单元测试（Host / PC 端）
- Mock / Stub 外设接口测试
- 仿真测试（如 QEMU / Verilator / Testbench）
- 明确的接口行为描述（当硬件不可测试时）

必须明确：
- 输入（寄存器 / 缓冲区 / 消息）
- 输出（状态、数据、回调、IO 变化）
- 异常情况（超时、CRC 错误、硬件未响应）

---

### Step 2：测试优先（Test First）
Agent 应优先编写以下之一：

- 驱动接口的 Mock 测试
- 协议解析 / 数据处理的纯逻辑测试
- 状态机转换测试
- 时序 / 边界条件测试（最小值、最大值、超时）

⚠️ 即使无法在真实硬件上跑测试，也必须先定义**可验证的行为**。

---

### Step 3：最小实现（Minimal & Safe）
在测试或行为定义完成后，编写**最小可用实现**：

- 不提前做性能极限优化
- 不引入未经验证的中断/并发逻辑
- 不修改时钟、引脚、DMA 等全局配置，除非明确必要

目标：
- 功能正确
- 行为可预测
- 不破坏现有系统稳定性

---

### Step 4：重构与资源审视（Refactor with Constraints）
在功能正确后，允许重构，但必须同时评估：

- Flash / RAM 占用
- 栈深度
- 中断时延
- RTOS 任务调度影响

⚠️ 重构不得引入额外硬件依赖或不可测试路径。

---

## 4. 避免重复造轮子的嵌入式原则

在新增模块前，Agent 必须确认：

- 是否已有：
  - 通用驱动模板（I2C / SPI / UART）
  - 数据缓冲、环形队列、FIFO 实现
  - 滤波 / 特征提取 / 状态机逻辑
- 是否可以通过：
  - 参数化
  - 编译期配置（宏 / Kconfig）
  - 回调函数
来复用现有代码

---

## 5. 测试最低标准（Embedded-Friendly）

- 所有 **算法 / 协议 / 状态机** 必须可在 Host 端测试
- 驱动层至少提供：
  - Mock 接口
  - 清晰的 API 行为说明
- Bug 修复必须：
  - 先通过测试或最小复现步骤描述

推荐测试命名：
- `should_enter_sleep_after_timeout`
- `should_drop_packet_when_crc_invalid`

---

## 6. Agent 行为硬约束（Hard Rules）

Agent **禁止**：
- 直接操作未说明的寄存器
- 在不了解中断上下文的情况下写 ISR 逻辑
- 修改硬件配置却不说明影响范围

Agent **必须**：
- 明确区分中断上下文与任务上下文
- 明确数据所有权（ISR / Task / DMA）

---

## 7. 输出与说明要求（When Agent Responds）

每次产出需明确说明：
1. 修改或新增了哪些文件
2. 是否新增测试 / Mock / 仿真
3. 复用了哪些已有模块
4. 是否引入新的硬件或资源假设


---

## 8. 核心原则（Guiding Principles）

- **Hardware-aware, test-driven**
- **Read schematics before writing code**
- **Behavior first, register second**
- **Small changes, measurable effects**
